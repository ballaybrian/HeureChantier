<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Heure Chantier</title>

  <!-- PWA -->
  <link rel="manifest" href="/HeureChantier/manifest.webmanifest" />
  <meta name="theme-color" content="#0b1020" />
  <link rel="icon" href="/HeureChantier/assets/icon-192.png" />
  <link rel="apple-touch-icon" href="/HeureChantier/assets/apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <link rel="stylesheet" href="/HeureChantier/styles.css" />
</head>
<body>
  <main class="app">

    <header class="top">
      <div class="topLeft">
        <div class="pill" id="modePill">Mode: Lecture</div>
        <div class="mini" id="syncStatus">Initialisation…</div>
      </div>
      <div class="topRight">
        <button class="btn" id="btnAdmin">Mode admin</button>
        <button class="btn danger hidden" id="btnAdminOff">Quitter admin</button>
      </div>
    </header>

    <!-- HOME -->
    <section id="viewHome" class="view">
      <div class="center">
        <div class="appName">Heure Chantier</div>
        <div class="appSub">Ajout des heures • Chantiers • Paiements</div>

        <div class="menuList">
          <button class="menuBtn" data-go="addHours">
            <div class="menuTitle">Ajouter heure</div>
            <div class="menuDesc">Agent • Chantier • Date • Début/Fin</div>
          </button>

          <button class="menuBtn" data-go="sites">
            <div class="menuTitle">Chantier</div>
            <div class="menuDesc">Heures passées par chantier</div>
          </button>

          <button class="menuBtn" data-go="payments">
            <div class="menuTitle">Paiement</div>
            <div class="menuDesc">Sommes dues • payées • reste (par chantier)</div>
          </button>
        </div>

        <div class="footNote">
          Tout le monde peut voir. Seuls les admins peuvent modifier (code).
        </div>
      </div>
    </section>

    <!-- ADD HOURS -->
    <section id="viewAddHours" class="view hidden">
      <header class="bar">
        <button class="iconBtn" data-go="home">←</button>
        <div class="barTitle">Ajouter heure</div>
        <div></div>
      </header>

      <div class="card">
        <div class="warning hidden" id="readonlyAddHours">
          Mode lecture : passe en <b>Mode admin</b> pour ajouter/modifier.
        </div>

        <form id="hoursForm" class="form">
          <div class="field">
            <label>Agent</label>
            <div class="row">
              <select id="agentSelect" class="input"></select>
              <button id="btnAddAgentQuick" type="button" class="btn adminOnly">+ Agent</button>
            </div>
          </div>

          <div class="field">
            <label>Chantier</label>
            <div class="row">
              <select id="siteSelect" class="input"></select>
              <button id="btnAddSiteQuick" type="button" class="btn adminOnly">+ Chantier</button>
            </div>
          </div>

          <div class="field">
            <label>Date</label>
            <input id="workDate" type="date" class="input" required />
          </div>

          <div class="field">
            <label>Heure début</label>
            <input id="startTime" type="time" class="input" required />
          </div>

          <div class="field">
            <label>Heure fin</label>
            <input id="endTime" type="time" class="input" required />
          </div>

          <div class="summary">
            <div class="sumRow">
              <span>Durée</span>
              <b id="durationOut">0.00 h</b>
            </div>
            <div class="sumRow">
              <span>Montant (taux agent)</span>
              <b id="amountOut">0,00 €</b>
            </div>
          </div>

          <button class="primaryBtn adminOnly" type="submit">Enregistrer</button>
        </form>
      </div>
    </section>

    <!-- SITES -->
    <section id="viewSites" class="view hidden">
      <header class="bar">
        <button class="iconBtn" data-go="home">←</button>
        <div class="barTitle">Chantier</div>
        <button id="btnAddSite" class="btn adminOnly">+ Ajouter chantier</button>
      </header>

      <div class="card">
        <div class="field">
          <label>Nom du chantier</label>
          <select id="sitePick" class="input"></select>
        </div>

        <div class="divider"></div>

        <div class="sectionTitle">Heures passées</div>
        <div id="siteEntriesList" class="list"></div>
      </div>
    </section>

    <!-- PAYMENTS -->
    <section id="viewPayments" class="view hidden">
      <header class="bar">
        <button class="iconBtn" data-go="home">←</button>
        <div class="barTitle">Paiement</div>
        <button id="btnAddAgent" class="btn adminOnly">+ Ajouter agent</button>
      </header>

      <div class="card">
        <!-- ✅ Sélection chantier pour paiements -->
        <div class="field">
          <label>Chantier</label>
          <select id="paySitePick" class="input"></select>
        </div>

        <div class="divider"></div>

        <div class="sectionTitle">Sommes par agent (chantier sélectionné)</div>
        <div id="agentPayTable" class="table"></div>
      </div>

      <!-- Modal paiement -->
      <div id="payModal" class="modal hidden">
        <div class="modalCard">
          <div class="modalTitle">Ajouter paiement</div>
          <div class="modalSub" id="payModalAgent">Agent</div>

          <form id="payForm" class="form">
            <div class="field">
              <label>Date</label>
              <input id="payDate" type="date" class="input" required />
            </div>
            <div class="field">
              <label>Montant (€)</label>
              <input id="payAmount" type="number" step="0.01" min="0" class="input" required />
            </div>

            <div class="row">
              <button class="primaryBtn adminOnly" type="submit">Valider</button>
              <button id="btnClosePay" type="button" class="btn ghost">Annuler</button>
            </div>

            <div class="warning tiny hidden" id="readonlyPay">
              Mode lecture : passe en <b>Mode admin</b> pour ajouter.
            </div>
          </form>
        </div>
      </div>
    </section>

    <!-- ADMIN MODAL -->
    <div id="adminModal" class="modal hidden">
      <div class="modalCard">
        <div class="modalTitle">Mode admin</div>
        <div class="modalSub">Entre le code admin pour déverrouiller les modifications.</div>

        <form id="adminForm" class="form">
          <div class="field">
            <label>Code admin</label>
            <input id="adminCode" type="password" class="input" placeholder="••••••" required />
          </div>

          <div class="row">
            <button class="primaryBtn" type="submit">Activer</button>
            <button id="btnCloseAdmin" type="button" class="btn ghost">Annuler</button>
          </div>

          <div id="adminMsg" class="warning tiny hidden"></div>
        </form>
      </div>
    </div>

  </main>

  <script type="module" src="/HeureChantier/firebase.js"></script>
  <script type="module" src="/HeureChantier/app.js"></script>
</body>
</html>
